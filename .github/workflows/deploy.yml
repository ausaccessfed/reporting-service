name: Run
on:
  push:
  schedule:
    - cron: '0 0 1 * *'
  issue_comment:
    types: [created]
jobs:
  all:
    concurrency:
      group: ${{ github.event.comment.id }}-${{ github.event_name }}-${{ ( github.ref_name == 'master' || github.ref_name == 'main' ) && github.sha || github.ref_name }}-build
      cancel-in-progress: true
    permissions:
      id-token: write
      contents: read
      statuses: write
      issues: read
      pull-requests: write
      packages: write
    secrets: inherit
    uses: ausaccessfed/workflows/.github/workflows/deploy-sync.yml@main
    with:
      event_name: ${{ github.event_name }}
      event_comment_id: ${{ github.event.comment.id }}
      event_comment_body: ${{ github.event.comment.body }}
      ecr_repository: reporting-service
      dev_url: https://reporting.dev.aaf.edu.au
      production_environments: 'test,production'
      platforms: "['linux/amd64','linux/arm64']"
      commands: |
        [
          'docker run --add-host=host.docker.internal:host-gateway -e REPORTING_DB_HOST=host.docker.internal -e PREPARE_DB=true -e REPORTING_DB_USERNAME=root -e REPORTING_DB_PASSWORD=password -e RAILS_ENV=test {0} bundle exec rspec',
          'docker run {0} bundle exec rubocop -P',
          'docker run {0} bundle exec brakeman',
          'docker run {0} bundle exec rake lint_rb',
          'docker run {0} bundle exec rake lint_js',
          'docker run {0} bundle exec rake lint_md'
        ]
